<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>板块股票列表</title>
    <link rel="stylesheet" href="css/font-awesome/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable:hover {
            color: #4a9eff;
        }

        .sortable::after {
            content: "↕";
            position: absolute;
            right:5px;
            opacity: 0.5;
            font-size: 14px;
        }

        .sortable.asc::after {
            content: "↑";
            opacity: 1;
        }

       .sortable.desc::after {
            content: "↓";
            opacity: 1;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: #252538;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
        }

        th, td {
            border: none;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }

        th {
            background-color: #1a1a2e;
            color: #888;
            font-weight: normal;
            position: sticky;
            top: 0;
            z-index: 1;
            font-size: 0.85rem;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        #chartContainer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            background: #252538;
            border-radius: 8px;
            padding: 15px;
        }

        .chart-btn {
            cursor: pointer;
            color: #4a9eff;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(74, 158, 255, 0.1);
            transition: all 0.2s;
            border: none;
            outline: none;
        }

        .chart-btn:hover {
            background: rgba(74, 158, 255, 0.2);
        }

        .positive {
            color: #22e090;
        }

        .negative {
            color: #ff5252;
        }

        input, button {
            background: #252538;
            border: 1px solid #333;
            color: #ee0ee0;
            padding: 6px 10px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #3a8eff;
        }

        .stock-flag {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            position: relative;
        }

        .stock-flag i {
            font-size: 12px;
            padding: 4px;
            border-radius: 50%;
            background: rgba(74, 158, 255, 0.1);
            transition: all 0.3s ease;
            color: #4a9eff;
        }

        .stock-flag:hover i {
            transform: scale(1.1);
            background: rgba(74, 158, 255, 0.2);
        }

        .stock-flag:hover .tooltip {
            visibility: visible;
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #1a1a2e, #252538);
            color: #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            width: max-content;
            max-width: 400px;
            z-index: 1000;
            margin-left: 10px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(74, 158, 255, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: transparent rgba(26, 26, 46, 0.95) transparent transparent;
        }

        .stock-flag:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .flag-info {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .flag-info:first-child {
            margin-top: 0;
        }
        
        .flag-info:last-child {
            margin-bottom: 0;
        }

        .flag-info strong {
            color: #4a9eff;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            th, td {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="card">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                板块股票列表
            </div>
            <div>
                板块：<span id="blockName"></span>
            </div>
        </div>
    </div>
    <div id="result"></div>
    <!-- 模态框 -->
    <div id="chartModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:800px;background:#252538;padding:20px;border-radius:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 id="modalTitle" style="margin:0;">分时图</h3>
                <button onclick="if (timeChartTimer) { clearInterval(timeChartTimer); timeChartTimer = null; } document.getElementById('chartModal').style.display='none'" style="background:none;border:none;color:#aaa;font-size:20px;cursor:pointer;">×</button>
            </div>
            <div id="modalChartContainer" style="width:100%;height:400px;"></div>
        </div>
    </div>    <script src="js/jquery.min.js"></script>
    <script src="js/echarts.js"></script>    <script>
        const TRADING_TIMES = {
            morning: {
                start: '09:30',
                end: '11:30'
            },
            afternoon: {
                start: '13:00',
                end: '15:00'
            }
        };

        function isTradeTime() {
            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');
            const day = now.getDay();

            // 排除周末
            if (day === 0 || day === 6) return false;

            // 判断是否在交易时间内
            return (time >= TRADING_TIMES.morning.start && time <= TRADING_TIMES.morning.end) ||
                   (time >= TRADING_TIMES.afternoon.start && time <= TRADING_TIMES.afternoon.end);
        }

        function processTimeChartData(trends) {const TRADING_TIMES = {
                morning: {
                    start: '09:30',
                    end: '11:30'
                },
                afternoon: {
                    start: '13:00',
                    end: '15:00'
                }
            };

            function isTradeTime() {
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' + 
                            now.getMinutes().toString().padStart(2, '0');
                const day = now.getDay();

                // 排除周末
                if (day === 0 || day === 6) return false;

                // 判断是否在交易时间内
                return (time >= TRADING_TIMES.morning.start && time <= TRADING_TIMES.morning.end) ||
                       (time >= TRADING_TIMES.afternoon.start && time <= TRADING_TIMES.afternoon.end);
            }

            function generateMinuteTimeAxis() {
                const times = [];
                const addMinutes = (time, mins) => {
                    const [hours, minutes] = time.split(':').map(Number);
                    let totalMinutes = hours * 60 + minutes + mins;
                    let newHours = Math.floor(totalMinutes / 60);
                    let newMinutes = totalMinutes % 60;
                    return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                };

                let currentTime = TRADING_TIMES.morning.start;
                while (currentTime <= TRADING_TIMES.morning.end) {
                    times.push(currentTime);
                    currentTime = addMinutes(currentTime, 1);
                }
                currentTime = TRADING_TIMES.afternoon.start;
                while (currentTime <= TRADING_TIMES.afternoon.end) {
                    times.push(currentTime);
                    currentTime = addMinutes(currentTime, 1);
                }
                return times;
            }
            
            const timeAxis = generateMinuteTimeAxis();
            
            const timeValueMap = {};
            let lastMorningPrice = null;

            trends.forEach(item => {
                const parts = item.split(',');
                const time = parts[0].substring(11, 16);
                const price = parseFloat(parts[2]);
                const volume = parseInt(parts[5]);
                
                if (time <= '11:30') {
                    lastMorningPrice = price;
                }
                
                timeValueMap[time] = {
                    price: price,
                    volume: volume
                };
            });

            const priceData = [];
            const volumeData = [];
            let lastValidPrice = null;
            
            timeAxis.forEach(time => {
                if (timeValueMap[time]) {
                    priceData.push(timeValueMap[time].price);
                    volumeData.push(timeValueMap[time].volume);
                    lastValidPrice = timeValueMap[time].price;
                } else if (time >= '11:30' && time < '13:00') {
                    priceData.push(lastMorningPrice || lastValidPrice);
                    volumeData.push(0);
                } else {
                    priceData.push(lastValidPrice);
                    volumeData.push(0);
                }
            });

            return { priceData, volumeData, timeAxis };
        }

        // 计算涨跌幅
        function ratioCalculate(price, yclose) {
            return ((price - yclose) / yclose * 100).toFixed(2);
        }

        // 计算价格和涨跌幅的区间
        function getMinMax(priceData, preClose) {
            const values = priceData.filter(val => val !== null);
            const maxa = Math.max(...values);
            const mina = Math.min(...values);
            const zfa = Math.abs((maxa / preClose - 1));
            const zfb = Math.abs((mina / preClose - 1));
            
            function minValue() {
                if(zfa >= zfb){
                    return Number(preClose * (1 - zfa)).toFixed(2);
                }else{
                    return mina;
                }
            }
            function maxValue() {
                if(zfb >= zfa){
                    return Number(preClose * (1 + zfb)).toFixed(2);
                }else{
                    return maxa;
                }
            }
            
            const _interval = (maxValue() - minValue()) / 4;
            return { min: minValue(), max: maxValue(), interval: _interval };
        }

        let currentSortField = null;
        let sortDirection = 1;
        let currentData = null;
        let timeChart = null;
        let lastStockCode = null;
        let timeChartTimer = null;

        function showTimeChart(stockCode, stockName) {
            const timestamp = Date.now();
            const marketPrefix = (stockCode.startsWith('6') ? '1' : '0');
            const url = `https://push2his.eastmoney.com/api/qt/stock/trends2/get?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f52,f53,f54,f55,f56,f57,f58&secid=${marketPrefix}.${stockCode}&_=${timestamp}`;
            
            const modal = document.getElementById('chartModal');
            const chartContainer = document.getElementById('modalChartContainer');
            
            // 清除旧的定时器
            if (timeChartTimer) {
                clearInterval(timeChartTimer);
                timeChartTimer = null;
            }
            
            modal.style.display = 'block';
            document.getElementById('modalTitle').textContent = `${stockName}（${stockCode}）分时图`;
            
            // 如果图表实例不存在或已被销毁，则创建新的
            if (!timeChart || timeChart.isDisposed()) {
                chartContainer.innerHTML = ''; // 清空容器
                timeChart = echarts.init(chartContainer);
            }
            
            timeChart.showLoading({
                text: '加载中...',
                color: '#4a9eff',
                textColor: '#aaa',
                maskColor: 'rgba(0, 0, 0, 0)'
            });
            
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    timeChart.hideLoading();
                    if (data.data && data.data.trends) {
                        drawTimeChart(stockCode, data);
                    } else {
                        timeChart.showLoading({
                            text: '没有获取到有效的分时图数据',
                            color: '#ff5252',
                            textColor: '#ff5252',
                            maskColor: 'rgba(0, 0, 0, 0)'
                        });
                    }
                },
                error: function(error) {
                    console.error('获取分时图数据失败:', error);
                    timeChart.showLoading({
                        text: '获取分时图数据失败',
                        color: '#ff5252',
                        textColor: '#ff5252',
                        maskColor: 'rgba(0, 0, 0, 0)'
                    });
                }
            });
        }

        function drawTimeChart(stockCode, data) {
            if (!data.data || !data.data.trends) {
                return;
            }

            lastStockCode = stockCode;
            const { priceData, volumeData, timeAxis } = processTimeChartData(data.data.trends);
            const preClose = data.data.preClose;
            const { min, max, interval } = getMinMax(priceData, preClose);            const option = {
                title: { show: false },
                animation: false,
                grid: [
                    {
                        left: '10%',
                        right: '10%',
                        top: '8%',
                        height: '60%'
                    },
                    {
                        left: '10%',
                        right: '10%',
                        top: '75%',
                        height: '20%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: timeAxis,
                        boundaryGap: false,
                        axisLine: { 
                            show: true,
                            lineStyle: {
                                color: '#555'
                            }
                        },
                        axisLabel: {
                            color: '#aaa',
                            fontSize: 12,                            formatter: function(value) {
                                if (value === '09:30' || value === '10:30' || value === '11:30' || 
                                    value === '13:00' || value === '14:00' || value === '15:00' ||
                                    (value.split(':')[1] === '00' && value !== '13:00')) {
                                    return value;
                                }
                                return '';
                            }
                        },
                        axisTick: { show: false }
                    },
                    {
                        gridIndex: 1,
                        type: 'category',
                        data: timeAxis,
                        boundaryGap: false,
                        axisLine: { show: true },
                        axisLabel: { show: false },
                        axisTick: { show: false }
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        position: 'left',
                        scale: true,
                        min: min,
                        max: max,
                        interval: interval,
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#333',
                                type: 'dashed'
                            }
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#555'
                            }
                        },
                        axisLabel: {
                            color: function(value) {
                                if (value == preClose) return '#fff';
                                return value > preClose ? '#ff3333' : '#00ff00';
                            },
                            formatter: function(value) {
                                return Number(value).toFixed(2);
                            }
                        }
                    },
                    {
                        type: 'value',
                        position: 'right',
                        min: min,
                        max: max,
                        interval: interval,
                        splitLine: { show: false },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#555'
                            }
                        },
                        axisLabel: {
                            color: function(value) {
                                const ratio = ratioCalculate(value, preClose);
                                if (ratio == 0) return '#fff';
                                return ratio > 0 ? '#ff3333' : '#00ff00';
                            },
                            formatter: function(value) {
                                return ratioCalculate(value, preClose) + '%';
                            }
                        }
                    },
                    {
                        gridIndex: 1,
                        type: 'value',
                        position: 'right',
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#333',
                                type: 'dashed'
                            }
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#555'
                            }
                        },
                        axisLabel: {
                            color: '#aaa',
                            formatter: function(value) {
                                return (value/10000).toFixed(0) + '万';
                            }
                        }
                    }
                ],
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(30,30,45,0.95)',
                    borderColor: '#444',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        let price, volume;
                        params.forEach(param => {
                            if (param.seriesName === '价格') {
                                price = param.value;
                                const color = price > preClose ? '#ff3333' : '#00ff00';
                                result += `价格: <span style="color:${color}">${price.toFixed(2)}</span><br/>`;
                                result += `涨跌幅: <span style="color:${color}">${ratioCalculate(price, preClose)}%</span><br/>`;
                            } else if (param.seriesName === '成交量') {
                                volume = param.value;
                                result += `成交量: ${(volume/10000).toFixed(0)}万手`;
                            }
                        });
                        return result;
                    }
                },
                series: [
                    {
                        name: '价格',
                        type: 'line',
                        data: priceData,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1,
                            color: '#4a9eff'
                        },
                    markLine: {
                        symbol: 'none',
                        label: { show: false },
                        lineStyle: {
                            color: '#888',
                            type: 'dashed'
                        },
                        data: [
                            { yAxis: preClose },
                            {
                                yAxis: priceData[timeAxis.indexOf(new Date().getHours() + ':' + (new Date().getMinutes() < 10 ? '0' + new Date().getMinutes() : new Date().getMinutes()))] || preClose,
                                y2: preClose,
                                lineStyle: {
                                    type: 'dashed',
                                    color: '#FFA500'
                                }
                            }
                        ]
                    }
                    },
                    {
                        name: '成交量',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 2,
                        data: volumeData,
                        barMaxWidth: 20,
                        itemStyle: {
                            color: function(params) {
                                const value = params.value;
                                if (value === 0) return '#555';
                                if (priceData[params.dataIndex] >= (priceData[params.dataIndex-1] || preClose)) {
                                    return '#ff3333';
                                }
                                return '#00ff00';
                            }
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    }
                ]
            };

            timeChart.setOption(option, true);
            
            if (timeChartTimer) {
                clearInterval(timeChartTimer);
            }
              let lastDataTime = '';
            
            const updateData = () => {
                if (!isTradeTime()) {
                    return;
                }

                const timestamp = Date.now();
                const marketPrefix = (stockCode.startsWith('6') ? '1' : '0');
                const url = `https://push2his.eastmoney.com/api/qt/stock/trends2/get?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f52,f53,f54,f55,f56,f57,f58&secid=${marketPrefix}.${stockCode}&_=${timestamp}`;
                
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function(newData) {
                        if (!newData.data || !newData.data.trends || !newData.data.trends.length) {
                            return;
                        }

                        const latestData = newData.data.trends[newData.data.trends.length - 1];
                        const latestTime = latestData.split(',')[0].substring(11, 16);

                        // 如果数据时间没有更新，不做处理
                        if (latestTime === lastDataTime) {
                            return;
                        }

                        lastDataTime = latestTime;
                        const { priceData: newPriceData, volumeData: newVolumeData } = processTimeChartData(newData.data.trends);

                        // 增量更新数据，保持其他配置不变
                        timeChart.setOption({
                            series: [
                                { 
                                    data: newPriceData,
                                    markLine: {
                                        data: [
                                            { yAxis: preClose },
                                            {
                                                yAxis: newPriceData[timeAxis.indexOf(lastDataTime)] || preClose,
                                                y2: preClose,
                                                lineStyle: {
                                                    type: 'dashed',
                                                    color: '#FFA500'
                                                }
                                            }
                                        ]
                                    }
                                },
                                { data: newVolumeData }
                            ]
                        }, {
                            notMerge: false,
                            lazyUpdate: true,
                            silent: true
                        });
                    }
                });
            };

            // 设置更新间隔为3秒
            timeChartTimer = setInterval(updateData, 3000);
        }

        // Stock pool functions using localStorage
        const STOCK_POOL_KEY = 'stock_pool';

        function getStockPool() {
            const poolStr = localStorage.getItem(STOCK_POOL_KEY);
            if (poolStr) {
                try {
                    return JSON.parse(poolStr);
                } catch (e) {
                    console.error('Error parsing stock pool', e);
                }
            }
            return [];
        }

        function saveStockPool(pool) {
            localStorage.setItem(STOCK_POOL_KEY, JSON.stringify(pool));
        }

        function toggleStockInPool(stockCode, stockName, element) {
            const pool = getStockPool();
            const existingIndex = pool.findIndex(item => item.code === stockCode);
            
            if (existingIndex !== -1) {
                // Remove from pool
                pool.splice(existingIndex, 1);
                element.textContent = '+';
                element.classList.remove('in-pool');
            } else {
                // Add to pool with current date
                const date = new Date();
                const dateString = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                pool.push({ 
                    code: stockCode, 
                    name: stockName,
                    date: dateString,
                    change: 0 // 添加默认涨跌幅
                });
                element.textContent = '-';
                element.classList.add('in-pool');
            }
            saveStockPool(pool);
        }

        function isInStockPool(stockCode) {
            return getStockPool().some(item => item.code === stockCode);
        }

        function getBlockCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const blockCode = urlParams.get('blockCode');
            if (blockCode && !blockCode.startsWith('BK')) {
                return 'BK' + blockCode;
            }
            return blockCode && blockCode.trim() !== '' ? blockCode : null;
        }

        function fetchBlockName(blockCode, callback) {
            console.log('Fetching block name for:', blockCode);
            
            if (window.industryBoards && window.conceptBoards) {
                console.log('Using global boards data');
                findBlockName(blockCode, window.industryBoards, window.conceptBoards, callback);
                return;
            }
            
            try {
                const industryBoards = JSON.parse(localStorage.getItem('industryBoards') || '[]');
                const conceptBoards = JSON.parse(localStorage.getItem('conceptBoards') || '[]');
                
                if (industryBoards.length > 0 && conceptBoards.length > 0) {
                    console.log('Using localStorage boards data');
                    findBlockName(blockCode, industryBoards, conceptBoards, callback);
                    return;
                }
            } catch (e) {
                console.error('加载本地存储的板块数据失败', e);
            }
            
            console.log('Fetching boards data from API');
            const industryUrl = 'https://push2.eastmoney.com/api/qt/clist/get?fid=f12&po=1&pz=1000&pn=1&np=1&fltt=2&invt=2&fs=m:90+t:2';
            const conceptUrl = 'https://push2.eastmoney.com/api/qt/clist/get?fid=f12&po=1&pz=1000&pn=1&np=1&fltt=2&invt=2&fs=m:90+t:3';
            
            Promise.all([
                fetch(industryUrl).then(res => res.json()),
                fetch(conceptUrl).then(res => res.json())
            ]).then(([industryData, conceptData]) => {
                console.log('API industry data:', industryData);
                console.log('API concept data:', conceptData);
                
                const industryBoards = industryData.data?.diff?.map(item => ({
                    code: item.f12,
                    name: item.f14
                })) || [];
                
                const conceptBoards = conceptData.data?.diff?.map(item => ({
                    code: item.f12,
                    name: item.f14
                })) || [];
                
                console.log('Processed industry boards:', industryBoards);
                console.log('Processed concept boards:', conceptBoards);
                
                window.industryBoards = industryBoards;
                window.conceptBoards = conceptBoards;
                try {
                    localStorage.setItem('industryBoards', JSON.stringify(industryBoards));
                    localStorage.setItem('conceptBoards', JSON.stringify(conceptBoards));
                } catch (e) {
                    console.error('保存到localStorage失败', e);
                }
                
                console.log('API boards data loaded and processed');
                findBlockName(blockCode, industryBoards, conceptBoards, callback);
            }).catch(error => {
                console.error('从API获取板块数据失败:', error);
                callback(blockCode);
            });
        }
        
        function findBlockName(blockCode, industryBoards, conceptBoards, callback) {
            console.log('Searching for block:', blockCode);
            console.log('Industry boards:', industryBoards);
            console.log('Concept boards:', conceptBoards);
            
            const numericCode = blockCode.startsWith('BK') ? blockCode.substring(2) : blockCode;
            
            const industryMatch = industryBoards.find(board => {
                const match = board.code === blockCode || 
                             board.code === numericCode ||
                             board.code === `BK${numericCode}`;
                if (match) console.log('Industry match:', board);
                return match;
            });
            
            if (industryMatch) {
                console.log('Found industry match:', industryMatch);
                callback(industryMatch.name);
                return;
            }
            
            const conceptMatch = conceptBoards.find(board => {
                const match = board.code === blockCode || 
                             board.code === numericCode ||
                             board.code === `BK${numericCode}`;
                if (match) console.log('Concept match:', board);
                return match;
            });
            
            if (conceptMatch) {
                console.log('Found concept match:', conceptMatch);
                callback(conceptMatch.name);
                return;
            }
            
            console.log('No match found for block:', blockCode);
            callback(blockCode);
        }

        function fetchStockList(blockCode) {
            if (!blockCode) {
                blockCode = getBlockCodeFromUrl();  // 修正拼写
                if (!blockCode) {
                    $('#result').html('<p>请提供板块代码或名称</p>');
                    return;
                }
            }
            
            if (/^\d+$/.test(blockCode)) {
                blockCode = 'BK' + blockCode;
            }
            
            fetchBlockName(blockCode, function(blockName) {
                console.log('Fetched block name:', blockName, 'for code:', blockCode);
                if (blockName && blockName !== blockCode) {
                    $('#blockName').text(blockName + ' (' + blockCode + ')');
                } else {
                    $('#blockName').text(blockCode);
                }
            });

            $.ajax({
                url: `https://push2.eastmoney.com/api/qt/clist/get?fid=f12&po=1&pz=100&pn=1&np=1&fltt=2&invt=2&fs=b:${blockCode}&fields=f12,f14,f2,f3,f4,f62,f184,f66,f69,f72,f75,f78,f81,f84,f87,f204,f205,f124`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    displayStockList(data);
                },
                error: function(error) {
                    console.error('Error:', error);
                    $('#result').html('<p>获取数据失败，请重试</p>');
                }
            });
        }

        async function fetchLimitUpData() {
            try {
                const response = await fetch(`https://data.10jqka.com.cn/dataapi/limit_up/block_top`, {
                    headers: {
                        'Accept': 'application/json',
                        'Referer': 'https://data.10jqka.com.cn/',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('涨停数据:', data);

                if (data && data.data && Array.isArray(data.data)) {
                    const stockMap = new Map();
                    
                    data.data.forEach(block => {
                        if (block.stock_list && Array.isArray(block.stock_list)) {
                            block.stock_list.forEach(stock => {
                                if (stock.code && typeof stock.code === 'string') {
                                    stockMap.set(stock.code, {
                                        high: stock.high || '涨停',
                                        reason_type: stock.reason_type || '未知原因',
                                        reason_info: stock.reason_info || '-',
                                        change_tag: stock.change_tag || '-'
                                    });
                                }
                            });
                        }
                    });
                    
                    console.log('涨停股票Map:', stockMap);
                    return stockMap;
                } else {
                    console.log('涨停数据为空');
                    return new Map();
                }
            } catch (error) {
                console.error('获取涨停数据失败:', error);
            }
            return new Map();
        }

        async function displayStockList(data) {
            if (!data.data || !data.data.diff) {
                $('#result').html('<p>没有找到股票数据</p>');
                return;
            }
            
            try {
                const limitUpMap = await fetchLimitUpData();
                console.log('获取到的涨停数据Map:', limitUpMap);
                console.log('涨停数据条数:', limitUpMap.size);
                console.log('股票列表数据:', data.data.diff);
                
                currentData = data;

let html = '<table><tr>' +
    '<th>代码</th>' +
    '<th>名称</th>' +
    '<th>最新价</th>' +
    '<th class="sortable" onclick="sortTable(\'f3\')">涨跌幅</th>' +
    '<th class="sortable" onclick="sortTable(\'f62\')">主力净流入(万)</th>' +
    '<th class="sortable" onclick="sortTable(\'f66\')">净流速(万)</th>' +
    '<th>分时图</th>' +
    '<th>收藏</th>' +  // New column for favorites
    '</tr>';
                
                data.data.diff.forEach(stock => {
                    const marketPrefix = stock.f12.startsWith('6') ? 'SH' : 'SZ';
                    const prefixedCode = marketPrefix + stock.f12;
                    
                    const limitUpInfo = 
                        limitUpMap.get(prefixedCode) || 
                        limitUpMap.get(stock.f12) || 
                        limitUpMap.get(stock.f12.substring(2));
                    
                    console.log(`股票${stock.f12}的涨停信息:`, limitUpInfo);
                    if (limitUpInfo) {
                        console.log(`为股票${stock.f14}(${stock.f12})添加涨停标记`);
                    }

                    const stockNameCell = `<td>
                        ${stock.f14}
                        ${limitUpInfo ? `
                            <span class="stock-flag">
                                <i class="fas fa-info-circle" style="color: #ff5252;"></i>
                                <div class="tooltip">
                                    <div class="flag-info"><strong>涨停类型:</strong> ${limitUpInfo.high}</div>
                                    <div class="flag-info"><strong>涨停原因:</strong> ${limitUpInfo.reason_type}</div>
                                    <div class="flag-info"><strong>详细信息:</strong> ${limitUpInfo.reason_info.replace(/\n/g, '<br>')}</div>
                                    ${limitUpInfo.change_tag ? `<div class="flag-info"><strong>标签:</strong> ${limitUpInfo.change_tag}</div>` : ''}
                                </div>
                            </span>
                        ` : ''}
                    </td>`;
                    
                    const inflow = stock.f62 ? (stock.f62 / 10000).toFixed(2) : '--';
                    const inflowColor = stock.f62 > 0 ? 'color:#f44336' : 'color:#4CAF50';
                    
                    const flowRate = stock.f66 ? (stock.f66 / 10000).toFixed(2) : '--';
                    const flowRateColor = stock.f66 > 0 ? 'color:#f44336' : 'color:#4CAF50';
                    
const isInPool = isInStockPool(stock.f12);
html += `<tr>
    <td>${stock.f12}</td>
    ${stockNameCell}
    <td>${stock.f2}</td>
    <td style="${stock.f3 > 0 ? 'color:#ff3333' : 'color:#00ff00'}">${stock.f3}%</td>
    <td style="${stock.f62 > 0 ? 'color:#ff3333' : 'color:#00ff00'}">${inflow}</td>
    <td style="${stock.f66 > 0 ? 'color:#ff3333' : 'color:#00ff00'}">${flowRate}</td>
    <td><span class="chart-btn" onclick="showTimeChart('${stock.f12}', '${stock.f14}')">查看</span></td>
<td><span class="chart-btn ${isInPool ? 'in-pool' : ''}" 
          onclick="toggleStockInPool('${stock.f12}', '${stock.f14.replace(/'/g, "\\'")}', this)">${isInPool ? '-' : '+'}</span></td>
</tr>`;
                });

                if (limitUpMap.size > 0) {
                    html += '</table>';
                    $('#result').html(html);
                } else {
                    html += '</table>';
                    $('#result').html(html + '<p class="no-limit-up">今日无涨停股票数据（可能是非交易日）</p>');
                }
            } catch (error) {
                console.error('显示股票列表时出错:', error);
                $('#result').html('<p>显示数据时出错，请重试</p>');
            }
        }

        function fetchTimeChartData(stockCode) {
            const timestamp = Date.now();
            const marketPrefix = (stockCode.startsWith('6') ? '1' : '0');
            const url = `https://push2his.eastmoney.com/api/qt/stock/trends2/get?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f52,f53,f54,f55,f56,f57,f58&secid=${marketPrefix}.${stockCode}&_=${timestamp}`;
            
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.data && data.data.trends) {
                        const { priceData, volumeData } = processTimeChartData(data.data.trends);
                        
                        if (timeChart && timeChart.getOption()) {
                            timeChart.setOption({
                                series: [
                                    { data: priceData },
                                    { data: volumeData }
                                ]
                            });
                        }
                    }
                },
                error: function(error) {
                    console.error('更新分时图数据失败:', error);
                }
            });
        }

        function sortTable(field) {
            if (!currentData || !currentData.data || !currentData.data.diff) return;
            
            if (currentSortField === field) {
                sortDirection *= -1;
            } else {
                currentSortField = field;
                sortDirection = 1;
            }
            
            document.querySelectorAll('.sortable').forEach(el => {
                el.classList.remove('asc', 'desc');
            });
            
            const header = document.querySelector(`th[onclick="sortTable('${field}')"]`);
            header.classList.add(sortDirection === 1 ? 'asc' : 'desc');
            
            currentData.data.diff.sort((a, b) => {
                const valA = a[field] || 0;
                const valB = b[field] || 0;
                return (valA - valB) * sortDirection;
            });
            
            displayStockList(currentData);
        }

        $(document).ready(function() {
            const blockCode = getBlockCodeFromUrl();
            if (blockCode) {
                fetchStockList(blockCode);
            }
        });
    </script>
</body>
</html>
