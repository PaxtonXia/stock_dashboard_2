<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>板块股票列表</title>
    <link rel="stylesheet" href="css/font-awesome/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable:hover {
            color: #4a9eff;
        }

        .sortable::after {
            content: "↕";
            position: absolute;
            right:5px;
            opacity: 0.5;
            font-size: 14px;
        }

        .sortable.asc::after {
            content: "↑";
            opacity: 1;
        }

       .sortable.desc::after {
            content: "↓";
            opacity: 1;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: #252538;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
        }

        th, td {
            border: none;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }

        th {
            background-color: #1a1a2e;
            color: #888;
            font-weight: normal;
            position: sticky;
            top: 0;
            z-index: 1;
            font-size: 0.85rem;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        #chartContainer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            background: #252538;
            border-radius: 8px;
            padding: 15px;
        }

        .chart-btn {
            cursor: pointer;
            color: #4a9eff;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(74, 158, 255, 0.1);
            transition: all 0.2s;
            border: none;
            outline: none;
        }

        .chart-btn:hover {
            background: rgba(74, 158, 255, 0.2);
        }

        .positive {
            color: #22e090;
        }

        .negative {
            color: #ff5252;
        }

        input, button {
            background: #252538;
            border: 1px solid #333;
            color: #ee0ee0;
            padding: 6px 10px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #3a8eff;
        }

        .stock-flag {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            position: relative;
        }

        .stock-flag i {
            font-size: 12px;
            padding: 4px;
            border-radius: 50%;
            background: rgba(74, 158, 255, 0.1);
            transition: all 0.3s ease;
            color: #4a9eff;
        }

        .stock-flag:hover i {
            transform: scale(1.1);
            background: rgba(74, 158, 255, 0.2);
        }

        .stock-flag:hover .tooltip {
            visibility: visible;
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #1a1a2e, #252538);
            color: #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            width: max-content;
            max-width: 400px;
            z-index: 1000;
            margin-left: 10px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(74, 158, 255, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: transparent rgba(26, 26, 46, 0.95) transparent transparent;
        }

        .stock-flag:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .flag-info {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .flag-info:first-child {
            margin-top: 0;
        }
        
        .flag-info:last-child {
            margin-bottom: 0;
        }

        .flag-info strong {
            color: #4a9eff;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            th, td {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="card">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                板块股票列表
            </div>
            <div>
                板块：<span id="blockName"></span>
            </div>
        </div>
    </div>
    <div id="result"></div>
    <!-- 模态框 -->
    <div id="chartModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:800px;background:#252538;padding:20px;border-radius:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 id="modalTitle" style="margin:0;">分时图</h3>
                <button onclick="if (timeChartTimer) { clearInterval(timeChartTimer); timeChartTimer = null; } document.getElementById('chartModal').style.display='none'" style="background:none;border:none;color:#aaa;font-size:20px;cursor:pointer;">×</button>
            </div>
            <div id="modalChartContainer" style="width:100%;height:400px;"></div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/echarts.js"></script>
    <script>
        let currentSortField = null;
        let sortDirection = 1;
        let currentData = null;
        let timeChart = null;
        let lastStockCode = null;
        let timeChartTimer = null;

        function getBlockCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const blockCode = urlParams.get('blockCode');
            if (blockCode && !blockCode.startsWith('BK')) {
                return 'BK' + blockCode;
            }
            return blockCode && blockCode.trim() !== '' ? blockCode : null;
        }

        function fetchBlockName(blockCode, callback) {
            console.log('Fetching block name for:', blockCode);
            
            if (window.industryBoards && window.conceptBoards) {
                console.log('Using global boards data');
                findBlockName(blockCode, window.industryBoards, window.conceptBoards, callback);
                return;
            }
            
            try {
                const industryBoards = JSON.parse(localStorage.getItem('industryBoards') || '[]');
                const conceptBoards = JSON.parse(localStorage.getItem('conceptBoards') || '[]');
                
                if (industryBoards.length > 0 && conceptBoards.length > 0) {
                    console.log('Using localStorage boards data');
                    findBlockName(blockCode, industryBoards, conceptBoards, callback);
                    return;
                }
            } catch (e) {
                console.error('加载本地存储的板块数据失败', e);
            }
            
            console.log('Fetching boards data from API');
            const industryUrl = 'https://push2.eastmoney.com/api/qt/clist/get?fid=f12&po=1&pz=1000&pn=1&np=1&fltt=2&invt=2&fs=m:90+t:2';
            const conceptUrl = 'https://push2.eastmoney.com/api/qt/clist/get?fid=f12&po=1&pz=1000&pn=1&np=1&fltt=2&invt=2&fs=m:90+t:3';
            
            Promise.all([
                fetch(industryUrl).then(res => res.json()),
                fetch(conceptUrl).then(res => res.json())
            ]).then(([industryData, conceptData]) => {
                console.log('API industry data:', industryData);
                console.log('API concept data:', conceptData);
                
                const industryBoards = industryData.data?.diff?.map(item => ({
                    code: item.f12,
                    name: item.f14
                })) || [];
                
                const conceptBoards = conceptData.data?.diff?.map(item => ({
                    code: item.f12,
                    name: item.f14
                })) || [];
                
                console.log('Processed industry boards:', industryBoards);
                console.log('Processed concept boards:', conceptBoards);
                
                window.industryBoards = industryBoards;
                window.conceptBoards = conceptBoards;
                try {
                    localStorage.setItem('industryBoards', JSON.stringify(industryBoards));
                    localStorage.setItem('conceptBoards', JSON.stringify(conceptBoards));
                } catch (e) {
                    console.error('保存到localStorage失败', e);
                }
                
                console.log('API boards data loaded and processed');
                findBlockName(blockCode, industryBoards, conceptBoards, callback);
            }).catch(error => {
                console.error('从API获取板块数据失败:', error);
                callback(blockCode);
            });
        }
        
        function findBlockName(blockCode, industryBoards, conceptBoards, callback) {
            console.log('Searching for block:', blockCode);
            console.log('Industry boards:', industryBoards);
            console.log('Concept boards:', conceptBoards);
            
            const numericCode = blockCode.startsWith('BK') ? blockCode.substring(2) : blockCode;
            
            const industryMatch = industryBoards.find(board => {
                const match = board.code === blockCode || 
                             board.code === numericCode ||
                             board.code === `BK${numericCode}`;
                if (match) console.log('Industry match:', board);
                return match;
            });
            
            if (industryMatch) {
                console.log('Found industry match:', industryMatch);
                callback(industryMatch.name);
                return;
            }
            
            const conceptMatch = conceptBoards.find(board => {
                const match = board.code === blockCode || 
                             board.code === numericCode ||
                             board.code === `BK${numericCode}`;
                if (match) console.log('Concept match:', board);
                return match;
            });
            
            if (conceptMatch) {
                console.log('Found concept match:', conceptMatch);
                callback(conceptMatch.name);
                return;
            }
            
            console.log('No match found for block:', blockCode);
            callback(blockCode);
        }

        function fetchStockList(blockCode) {
            if (!blockCode) {
                blockCode = getBlockCodeFromUrl();  // 修正拼写
                if (!blockCode) {
                    $('#result').html('<p>请提供板块代码或名称</p>');
                    return;
                }
            }
            
            if (/^\d+$/.test(blockCode)) {
                blockCode = 'BK' + blockCode;
            }
            
            fetchBlockName(blockCode, function(blockName) {
                console.log('Fetched block name:', blockName, 'for code:', blockCode);
                if (blockName && blockName !== blockCode) {
                    $('#blockName').text(blockName + ' (' + blockCode + ')');
                } else {
                    $('#blockName').text(blockCode);
                }
            });

            $.ajax({
                url: `https://push2.eastmoney.com/api/qt/clist/get?fid=f12&po=1&pz=100&pn=1&np=1&fltt=2&invt=2&fs=b:${blockCode}&fields=f12,f14,f2,f3,f4,f62,f184,f66,f69,f72,f75,f78,f81,f84,f87,f204,f205,f124`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    displayStockList(data);
                },
                error: function(error) {
                    console.error('Error:', error);
                    $('#result').html('<p>获取数据失败，请重试</p>');
                }
            });
        }

        async function fetchLimitUpData() {
            try {
                const response = await fetch(`https://data.10jqka.com.cn/dataapi/limit_up/block_top`, {
                    headers: {
                        'Accept': 'application/json',
                        'Referer': 'https://data.10jqka.com.cn/',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('涨停数据:', data);

                if (data && data.data && Array.isArray(data.data)) {
                    const stockMap = new Map();
                    
                    data.data.forEach(block => {
                        if (block.stock_list && Array.isArray(block.stock_list)) {
                            block.stock_list.forEach(stock => {
                                if (stock.code && typeof stock.code === 'string') {
                                    stockMap.set(stock.code, {
                                        high: stock.high || '涨停',
                                        reason_type: stock.reason_type || '未知原因',
                                        reason_info: stock.reason_info || '-',
                                        change_tag: stock.change_tag || '-'
                                    });
                                }
                            });
                        }
                    });
                    
                    console.log('涨停股票Map:', stockMap);
                    return stockMap;
                } else {
                    console.log('涨停数据为空');
                    return new Map();
                }
            } catch (error) {
                console.error('获取涨停数据失败:', error);
            }
            return new Map();
        }

        async function displayStockList(data) {
            if (!data.data || !data.data.diff) {
                $('#result').html('<p>没有找到股票数据</p>');
                return;
            }
            
            try {
                const limitUpMap = await fetchLimitUpData();
                console.log('获取到的涨停数据Map:', limitUpMap);
                console.log('涨停数据条数:', limitUpMap.size);
                console.log('股票列表数据:', data.data.diff);
                
                currentData = data;

                let html = '<table><tr>' +
                    '<th>代码</th>' +
                    '<th>名称</th>' +
                    '<th>最新价</th>' +
                    '<th class="sortable" onclick="sortTable(\'f3\')">涨跌幅</th>' +
                    '<th class="sortable" onclick="sortTable(\'f62\')">主力净流入(万)</th>' +
                    '<th class="sortable" onclick="sortTable(\'f66\')">净流速(万)</th>' +
                    '<th>分时图</th>' +
                    '</tr>';
                
                data.data.diff.forEach(stock => {
                    const marketPrefix = stock.f12.startsWith('6') ? 'SH' : 'SZ';
                    const prefixedCode = marketPrefix + stock.f12;
                    
                    const limitUpInfo = 
                        limitUpMap.get(prefixedCode) || 
                        limitUpMap.get(stock.f12) || 
                        limitUpMap.get(stock.f12.substring(2));
                    
                    console.log(`股票${stock.f12}的涨停信息:`, limitUpInfo);
                    if (limitUpInfo) {
                        console.log(`为股票${stock.f14}(${stock.f12})添加涨停标记`);
                    }

                    const stockNameCell = `<td>
                        ${stock.f14}
                        ${limitUpInfo ? `
                            <span class="stock-flag">
                                <i class="fas fa-info-circle" style="color: #ff5252;"></i>
                                <div class="tooltip">
                                    <div class="flag-info"><strong>涨停类型:</strong> ${limitUpInfo.high}</div>
                                    <div class="flag-info"><strong>涨停原因:</strong> ${limitUpInfo.reason_type}</div>
                                    <div class="flag-info"><strong>详细信息:</strong> ${limitUpInfo.reason_info.replace(/\n/g, '<br>')}</div>
                                    ${limitUpInfo.change_tag ? `<div class="flag-info"><strong>标签:</strong> ${limitUpInfo.change_tag}</div>` : ''}
                                </div>
                            </span>
                        ` : ''}
                    </td>`;
                    
                    const inflow = stock.f62 ? (stock.f62 / 10000).toFixed(2) : '--';
                    const inflowColor = stock.f62 > 0 ? 'color:#f44336' : 'color:#4CAF50';
                    
                    const flowRate = stock.f66 ? (stock.f66 / 10000).toFixed(2) : '--';
                    const flowRateColor = stock.f66 > 0 ? 'color:#f44336' : 'color:#4CAF50';
                    
                    html += `<tr>
                        <td>${stock.f12}</td>
                        ${stockNameCell}
                        <td>${stock.f2}</td>
                        <td style="${stock.f3 > 0 ? 'color:#f44336' : 'color:#4CAF50'}">${stock.f3}%</td>
                        <td style="${inflowColor}">${inflow}</td>
                        <td style="${flowRateColor}">${flowRate}</td>
                        <td><span class="chart-btn" onclick="showTimeChart('${stock.f12}', '${stock.f14}')">查看</span></td>
                    </tr>`;
                });

                if (limitUpMap.size > 0) {
                    html += '</table>';
                    $('#result').html(html);
                } else {
                    html += '</table>';
                    $('#result').html(html + '<p class="no-limit-up">今日无涨停股票数据（可能是非交易日）</p>');
                }
            } catch (error) {
                console.error('显示股票列表时出错:', error);
                $('#result').html('<p>显示数据时出错，请重试</p>');
            }
        }

        function showTimeChart(stockCode, stockName) {
            const timestamp = Date.now();
            const marketPrefix = (stockCode.startsWith('6') ? '1' : '0');
            const url = `https://push2his.eastmoney.com/api/qt/stock/trends2/get?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f52,f53,f54,f55,f56,f57,f58&secid=${marketPrefix}.${stockCode}&_=${timestamp}`;
            
            const modal = document.getElementById('chartModal');
            const chartContainer = document.getElementById('modalChartContainer');
            
            if (timeChart) {
                timeChart.dispose();
            }
            
            chartContainer.innerHTML = '<div style="text-align:center;padding:50px;color:#aaa;">加载中...</div>';
            modal.style.display = 'block';
            document.getElementById('modalTitle').textContent = `${stockName}（${stockCode}）分时图`;
            
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.data && data.data.trends) {
                        drawTimeChart(stockCode, data);
                    } else {
                        chartContainer.innerHTML = '<div style="text-align:center;padding:50px;color:#ff5252;">没有获取到有效的分时图数据</div>';
                    }
                },
                error: function(error) {
                    console.error('获取分时图数据失败:', error);
                    chartContainer.innerHTML = '<div style="text-align:center;padding:50px;color:#ff5252;">获取分时图数据失败</div>';
                }
            });
        }
        
        function generateTradingTimeAxis() {
            return [
                '09:30', '09:35', '09:40', '09:45', '09:50', '09:55',
                '10:00', '10:05', '10:10', '10:15', '10:20', '10:25', '10:30',
                '10:35', '10:40', '10:45', '10:50', '10:55',
                '11:00', '11:05', '11:10', '11:15', '11:20', '11:25', '11:30',
                '13:00', '13:05', '13:10', '13:15', '13:20', '13:25', '13:30', 
                '13:35', '13:40', '13:45', // 修正时间格式
                '13:50', '13:55',
                '14:00', '14:05', '14:10', '14:15', '14:20', '14:25', '14:30', '14:35', '14:40', '14:45', '14:50', '14:55',
                '15:00'
            ];
        }

        function processTimeChartData(trends) {
            const timeAxis = generateTradingTimeAxis();
            const timeValueMap = {};
            let firstPrice = null;
            let lastMorningPrice = null;  // 记录上午最后一个价格

            trends.forEach(item => {
                const parts = item.split(',');
                const time = parts[0].substring(11, 16);
                const price = parseFloat(parts[1]);
                const volume = parseInt(parts[5]);
                
                if (firstPrice === null) firstPrice = price;
                
                // 记录11:30的最后价格
                if (time <= '11:30') {
                    lastMorningPrice = price;
                }
                
                timeValueMap[time] = {
                    price: price,
                    volume: volume,
                    pricePercent: firstPrice !== 0 ? ((price - firstPrice) / firstPrice * 100) : 0
                };
            });

            const priceData = [];
            const volumeData = [];
            let lastValidPrice = null;
            
            timeAxis.forEach((time, index) => {
                if (timeValueMap[time]) {
                    // 有实际数据时使用实际数据
                    priceData.push(timeValueMap[time].price);
                    volumeData.push(timeValueMap[time].volume);
                    lastValidPrice = timeValueMap[time].price;
                } else if (time >= '11:30' && time < '13:00') {
                    // 在休市期间使用上午收盘价
                    priceData.push(lastMorningPrice || lastValidPrice);
                    volumeData.push(0);  // 休市期间成交量为0
                } else {
                    // 其他时间点使用最后一个有效价格
                    priceData.push(lastValidPrice);
                    volumeData.push(0);
                }
            });

            return { priceData, volumeData, timeAxis };
        }

        function drawTimeChart(stockCode, data) {
            if (!data.data || !data.data.trends) {
                return;
            }

            const container = document.getElementById('modalChartContainer');
            
            if (!timeChart || stockCode !== lastStockCode) {
                if (timeChart) timeChart.dispose();
                timeChart = echarts.init(container);
                lastStockCode = stockCode;
            }

            const { priceData, volumeData, timeAxis } = processTimeChartData(data.data.trends);

            const option = {
                title: {
                    text: `${stockCode} 分时图`,
                    left: 'center',
                    textStyle: {
                        color: '#fff',
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'line',
                        lineStyle: {
                            color: 'rgba(255,255,255,0.3)'
                        }
                    },
                    backgroundColor: 'rgba(30,30,48,0.9)',
                    borderColor: '#4a9eff',
                    borderWidth: 1,
                    textStyle: {
                        color: '#fff',
                        fontSize: 14
                    },
                    padding: 10,
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(item => {
                            let value = item.value;
                            let unit = item.seriesName === '价格' ? '元' : '手';
                            let color = item.color;
                            
                            const isValidValue = value != null && !isNaN(value);
                            
                            if (item.seriesName === '价格') {
                                result += `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${color};"></span>`;
                                result += `${item.seriesName}: <span style="color:${color};font-weight:bold">${
                                    isValidValue ? value.toFixed(2) + unit : '--'
                                }</span><br>`;
                            } else if (item.seriesName === '成交量') {
                                result += `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${color};"></span>`;
                                result += `${item.seriesName}: <span style="color:${color};font-weight:bold">${
                                    isValidValue ? (value/100).toFixed(2) + '万手' : '--'
                                }</span>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['价格', '成交量'],
                    top: 35,
                    textStyle: {
                        color: '#e0e0e0',
                        fontSize: 14
                    }
                },
                grid: [
                    {
                        left: '10%',
                        right: '10%',
                        top: '25%',
                        height: '50%',
                        backgroundColor: 'rgba(255,255,255,0.05)',
                        borderColor: 'rgba(255,255,255,0.1)'
                    },
                    {
                        left: '10%',
                        right: '10%',
                        top: '80%',
                        height: '15%'
                    }
                ],
                xAxis: [{
                    type: 'category',
                    data: timeAxis,
                    boundaryGap: false,
                    axisLine: { 
                        onZero: false,
                        lineStyle: {
                            color: '#aaa'
                        }
                    },
                    axisLabel: {
                        color: '#aaa',
                        fontSize: 12,
                        formatter: function(value) {
                            // 显示重要时间节点
                            if (value === '09:30' || value === '11:30' || 
                                value === '13:00' || value === '15:00' ||
                                value.split(':')[1] === '00') {
                                return value;
                            }
                            return '';
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: 'rgba(100,100,100,0.3)'
                        }
                    }
                },
                {
                    gridIndex: 1,
                    type: 'category',
                    data: timeAxis,
                    boundaryGap: false,
                    axisLine: { 
                        onZero: false,
                        lineStyle: {
                            color: '#aaa'
                        }
                    },
                    axisLabel: {
                        show: false
                    }
                }
                ],
                yAxis: [
                    {
                        name: '价格(元)',
                        type: 'value',
                        scale: true,
                        nameTextStyle: {
                            color: '#aaa',
                            fontSize: 12
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#aaa'
                            }
                        },
                        axisLabel: {
                            color: '#aaa',
                            fontSize: 12,
                            formatter: '{value}'
                        },
                        splitLine: {
                            lineStyle: {
                                color: 'rgba(100,100,100,0.3)'
                            }
                        }
                    },
                    {
                        gridIndex: 1,
                        name: '成交量(万手)',
                        type: 'value',
                        scale: true,
                        nameTextStyle: {
                            color: '#aaa',
                            fontSize: 12
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#aaa'
                            }
                        },
                        axisLabel: {
                            color: '#aaa',
                            fontSize: 12,
                            formatter: function(value) {
                                return (value / 10000).toFixed(0);
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                type: 'dashed',
                                color: 'rgba(100,100,100,0.3)'
                            }
                        }
                    }
                ],
                series: [{
                    name: '价格',
                    type: 'line',
                    data: priceData,
                    smooth: true,
                    connectNulls: true,  // 设置为true以连接断点
                    lineStyle: {
                        width: 3,
                        color: '#ffcc00'
                    },
                    itemStyle: {
                        color: '#ffcc00'
                    },
                    showSymbol: false,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(255,204,0,0.3)' },
                            { offset: 1, color: 'rgba(255,204,0,0.01)' }
                        ])
                    }
                },
                {
                    name: '成交量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumeData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#4a9eff' },
                            { offset: 1, color: '#1a5fb4' }
                        ])
                    },
                    barMaxWidth: '60%'
                }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    }
                ]
            };

            if (timeChart.getOption()) {
                timeChart.setOption({
                    series: [
                        { data: priceData },
                        { data: volumeData }
                    ]
                });
            } else {
                timeChart.setOption(option);
            }
            
            if (timeChartTimer) {
                clearInterval(timeChartTimer);
            }
            
            timeChartTimer = setInterval(() => {
                fetchTimeChartData(stockCode);
            }, 10000);
        }

        function fetchTimeChartData(stockCode) {
            const timestamp = Date.now();
            const marketPrefix = (stockCode.startsWith('6') ? '1' : '0');
            const url = `https://push2his.eastmoney.com/api/qt/stock/trends2/get?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f52,f53,f54,f55,f56,f57,f58&secid=${marketPrefix}.${stockCode}&_=${timestamp}`;
            
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.data && data.data.trends) {
                        const { priceData, volumeData } = processTimeChartData(data.data.trends);
                        
                        if (timeChart && timeChart.getOption()) {
                            timeChart.setOption({
                                series: [
                                    { data: priceData },
                                    { data: volumeData }
                                ]
                            });
                        }
                    }
                },
                error: function(error) {
                    console.error('更新分时图数据失败:', error);
                }
            });
        }

        function sortTable(field) {
            if (!currentData || !currentData.data || !currentData.data.diff) return;
            
            if (currentSortField === field) {
                sortDirection *= -1;
            } else {
                currentSortField = field;
                sortDirection = 1;
            }
            
            document.querySelectorAll('.sortable').forEach(el => {
                el.classList.remove('asc', 'desc');
            });
            
            const header = document.querySelector(`th[onclick="sortTable('${field}')"]`);
            header.classList.add(sortDirection === 1 ? 'asc' : 'desc');
            
            currentData.data.diff.sort((a, b) => {
                const valA = a[field] || 0;
                const valB = b[field] || 0;
                return (valA - valB) * sortDirection;
            });
            
            displayStockList(currentData);
        }

        $(document).ready(function() {
            const blockCode = getBlockCodeFromUrl();
            if (blockCode) {
                fetchStockList(blockCode);
            }
        });
    </script>
</body>
</html>
