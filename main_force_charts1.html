<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主力买卖分析</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #1f1f1f;
        }
        #tradeChart {
            width: 100%;
            height: 500px;
            margin: 0;
        }
        .main-buy {
            color: #ff1f1f;
            font-weight: bold;
        }
        .main-sell {
            color: #389e0d;
            font-weight: bold;
        }
    </style>
    <script src="https://cdn.bootcdn.net/ajax/libs/es6-promise/4.1.1/es6-promise.auto.min.js"></script>
    <script>
        if (!window.Promise) {
            document.write('<script src="https://cdn.bootcdn.net/ajax/libs/es6-promise/4.1.1/es6-promise.min.js"><\/script>');
        }
        
        (function(self) {
            'use strict';
            if (self.fetch) {
                return;
            }
            self.fetch = function(url) {
                return new Promise(function(resolve, reject) {
                    var xhr;
                    if (window.XMLHttpRequest) {
                        xhr = new XMLHttpRequest();
                    } else {
                        xhr = new ActiveXObject("Microsoft.XMLHTTP");
                    }
                    xhr.onload = function() {
                        resolve({
                            ok: xhr.status >= 200 && xhr.status < 300,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            json: function() {
                                try {
                                    return Promise.resolve(JSON.parse(xhr.responseText));
                                } catch(e) {
                                    return Promise.reject(e);
                                }
                            }
                        });
                    };
                    xhr.onerror = function() {
                        reject(new TypeError('Network request failed'));
                    };
                    xhr.open('GET', url, true);
                    xhr.send(null);
                });
            };
        })(window);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script>
        if (typeof echarts === 'undefined') {
            document.write('<script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"><\/script>');
        }
    </script>
    <style>
        body {
            font-family: Arial, "Microsoft YaHei", sans-serif;
            margin: 0;
            background-color: #1f1f1f;
        }
        #tradeChart {
            width: 100%;
            height: 500px;
            margin: 0;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="tradeChart"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            setInterval(fetchData, 1000);
        });

        function fetchData() {
            try {
                var stockCode = '000831';
                var query = window.location.search.substring(1);
                var vars = query.split('&');
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split('=');
                    if (pair[0] == 'code') {
                        stockCode = decodeURIComponent(pair[1]);
                        break;
                    }
                }
                
                var url = 'http://vaserviece.10jqka.com.cn/Level2/index.php?&op=mainMonitorDetail&stockcode=' + stockCode;
                
                return fetch(url).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    renderData(data);
                }).catch(function(error) {
                    console.error('获取数据失败:', error);
                });
            } catch (e) {
                console.error('获取数据时发生错误:', e);
                return Promise.reject(e);
            }
        }

        function renderData(data) {
            if (!data || !data.list || !(data.list instanceof Array)) {
                console.error('数据格式不正确');
                return;
            }
            
            // Generate continuous time series for trading hours (9:30-11:30, 13:00-15:00)
            function generateTimeSeries() {
                var times = [];
                // Morning session
                for (var hour = 9; hour <= 11; hour++) {
                    for (var minute = (hour === 9 ? 30 : 0); minute <= (hour === 11 ? 30 : 59); minute++) {
                        times.push((hour < 10 ? '0' + hour : hour) + ':' + (minute < 10 ? '0' + minute : minute));
                    }
                }
                // Afternoon session
                for (var hour = 13; hour <= 14; hour++) {
                    for (var minute = 0; minute <= 59; minute++) {
                        times.push(hour + ':' + (minute < 10 ? '0' + minute : minute));
                    }
                }
                // Last hour (15:00-15:00)
                times.push('15:00');
                return times;
            }

            var allTimes = generateTimeSeries();
            var tradesByTime = {};
            
            // Normalize and index trades by time (convert HH:MM:SS to HH:MM)
            for (var i = 0; i < data.list.length; i++) {
                var item = data.list[i];
                if (item.nature !== '主力主买' && item.nature !== '主力主卖') {
                    continue;
                }
                
                // Convert time to minute format (HH:MM)
                var timeParts = item.ctime.split(':');
                var normalizedTime = timeParts[0] + ':' + timeParts[1];
                
                var direction = item.tradetype === '1' ? 'buy' : 'sell';
                var amount = parseFloat(item.money) / 10000;
                var netAmount = direction === 'buy' ? amount : -amount;
                
                tradesByTime[normalizedTime] = {
                    value: netAmount,
                    color: getTradeColor(item.nature)
                };
            }

            // Create chart data with all times
            var chartData = {
                times: allTimes,
                amounts: []
            };

            for (var j = 0; j < allTimes.length; j++) {
                var time = allTimes[j];
                if (tradesByTime[time]) {
                    chartData.amounts.push({
                        value: tradesByTime[time].value,
                        itemStyle: { color: tradesByTime[time].color }
                    });
                } else {
                    // Null value for no trade
                    chartData.amounts.push(null);
                }
            }

            renderChart(chartData, data.title.stockname);
        }

        function getTradeColor(nature) {
            switch(nature) {
                case '主力主买': return '#ff1f1f';
                case '主力主卖': return '#389e0d';
                default: return '#999999';
            }
        }

        function renderChart(chartData, stockName) {
            try {
                if (typeof echarts === 'undefined') {
                    console.error('ECharts 库未加载成功');
                    return;
                }

                var chartDom = document.getElementById('tradeChart');
                var myChart = echarts.init(chartDom);
                
                const option = {
                    backgroundColor: '#1f1f1f',
                    title: {
                        text: stockName + ' - 主力买卖分析',
                        left: 'center',
                        textStyle: {
                            color: '#999'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function(params) {
                            var data = params[0];
                            if (!data.data) {
                                return data.name + '<br/>没有交易数据';
                            }
                            var tradeType = data.data.value >= 0 ? 
                                           '<span class="main-buy">主力主买</span>' : 
                                           '<span class="main-sell">主力主卖</span>';
                            
                            return data.name + '<br/>' +
                                   '类型: ' + tradeType + '<br/>' +
                                   '成交额: ' + Math.abs(data.value).toFixed(2) + ' 万元';
                        },
                        backgroundColor: 'rgba(50,50,50,0.9)',
                        borderColor: '#333',
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    grid: {
                        left: '15%',
                        right: '15%',
                        bottom: '20px',
                        top: '40px',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: chartData.times,
                        axisLabel: {
                            interval: function(index, value) {
                                // Only show labels at 15-minute intervals (00, 15, 30, 45 minutes)
                                var minutes = parseInt(value.split(':')[1]);
                                return minutes % 15 === 0;
                            },
                            color: '#999',
                            align: 'center',
                            padding: [0, 0, 0, 0]
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#333'
                            }
                        },
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '成交额（万元）',
                        nameTextStyle: {
                            color: '#999',
                            padding: [0, 0, 0, 20]
                        },
                        axisLabel: {
                            color: '#999',
                            formatter: function(value) {
                                return Math.abs(value);
                            }
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#333'
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#333',
                                type: 'dashed'
                            }
                        }
                    },
                    series: [{
                        type: 'bar',
                        data: chartData.amounts,
                        barWidth: '4px',
                        barGap: '2px',
                        barCategoryGap: '2px',
                        itemStyle: {
                            borderWidth: 1,
                            borderColor: '#1f1f1f',
                            borderType: 'solid'
                        },
                        label: {
                            show: false
                        },
                        emphasis: {
                            itemStyle: {
                                color: function(params) {
                                    return params.data.itemStyle.color;
                                }
                            }
                        }
                    }]
                };
        
                myChart.setOption(option);

                window.addEventListener('resize', function() {
                    myChart.resize();
                });
            } catch (error) {
                console.error('渲染图表时出错:', error);
            }
        }
    </script>
</body>
</html>
