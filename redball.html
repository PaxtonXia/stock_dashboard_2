<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>实时大单分时</title>
		<link href="css/redball.css" rel="stylesheet" type="text/css" />
		<style type="text/css">
			html, body { height: 100%; overflow: hidden; margin: 0; padding: 0; box-sizing: border-box; }
			p {margin:0px;}
			#box{
				display:inline-block;
				margin:0px 5px 0px 80px;
				border-box:50%;
				width:10px;
				height:10px;
			}
			.fixedBox{
				border: 1px solid #555555;
				
			}
			.fixedBox::-webkit-scrollbar {
				width: 10px;
				height: 10px;
			}
      .tabs {
        padding-top: 0;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        border-radius: 4px;
        padding: 8px 10px;
        background: rgba(37, 37, 56, 0.8);
      }
      
      .tabs span {
        cursor: pointer;
        padding: 5px 7px;
        margin-right: 10px;
        background-color: #222222;
        color: #e0e0e0;
        border-radius: 4px;
        transition: background-color 0.3s;
      }
      .filter-dropdown {
        height: 24px;
      }
      .tabs span:hover,
      .tabs .active {
        background-color: #800000;
      }
      #tempTitle {
        margin-bottom: 0;
      }
	.custom-button {
		display: inline-flex; /* 设置为内联弹性盒模型 */
		justify-content: center; /* 水平居中 */
		align-items: center; /* 垂直居中 */
		padding: 5px 7px; /* 匹配 tabs 样式 */
		background-color: #222222;
		color: #e0e0e0;
		border-radius: 4px;
		border: none;
		cursor: pointer;
		transition: background-color 0.3s;
		/* margin-right: 30px; */
		/* margin-top: 20px; */
		/* 其他样式，如背景色、边框等 */
	}

	.custom-button:hover {
		background-color: #800000;
	}
	
	.custom-button img {
		/* 调整图片大小或样式 */
		height: 16px; /* 示例值，根据实际需要调整 */
		width: auto; /* 保持图片原始宽高比 */
		vertical-align: middle; /* 对于非flexbox布局，可能需要此属性 */
	}

	.ai-modal {
	position: fixed;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	z-index: 9999;
	background: #2a2a40; /* 深色背景，参考floating-fund-flow */
	color: #fff;
	border-radius: 12px;
	box-shadow: 0 10px 40px rgba(0,0,0,0.5);
	width: 560px;
	height: 380px;
	border: 1px solid #3a3a5a;
	font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
	font-size: 14px;
	transition: all 0.3s ease;
	overflow: hidden;
	}
	.ai-modal-header {
        cursor: move;
        padding: 8px 16px; /* 高度改小 */
        background: rgba(60,60,60,0.7); /* 灰色半透明背景 */
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 15px;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #444;
        color: #e0e0e0;
    }
	.ai-modal-header::before {
		content: '🤖'; /* AI icon emoji */
		margin-right: 8px;
		font-size: 18px;
	}
	.ai-modal-close {
	background: none;
	border: none;
	color: #e0e0e0;
	font-size: 20px;
	cursor: pointer;
	padding: 4px;
	border-radius: 50%;
	transition: all 0.2s;
	opacity: 0.8;
	}
	.ai-modal-close:hover {
	opacity: 1;
	background: rgba(255,255,255,0.1);
	}
	.ai-modal-content {
  padding: 20px;
  font-size: 14px;
  color: #e0e0e0;
  line-height: 1.6;
  height: 280px;
  overflow-y: auto;
  box-sizing: border-box;
  background: rgba(255,255,255,0.02);
  }
	.ai-modal-content::-webkit-scrollbar {
		width: 6px;
	}
	.ai-modal-content::-webkit-scrollbar-track {
		background: rgba(255,255,255,0.05);
		border-radius: 3px;
	}
	.ai-modal-content::-webkit-scrollbar-thumb {
		background: rgba(255,255,255,0.2);
		border-radius: 3px;
	}
		.ai-bubble {
    background: rgba(128,0,0,0.15);
    color: #fff;
    border-radius: 8px;
    padding: 12px 16px;
    margin: 8px 0;
    font-size: 14px;
    line-height: 1.6;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
    word-break: break-word;
    border: 1px solid rgba(128,0,0,0.3);
    max-width: 100%;
}

        .chart-btn {
            cursor: pointer;
            color: #4a9eff;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(74, 158, 255, 0.1);
            transition: all 0.2s;
            border: none;
            outline: none;
        }

        .chart-btn:hover {
            background: rgba(74, 158, 255, 0.2);
        }

        .chart-btn.in-pool {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .chart-btn.in-pool:hover {
            background: rgba(255, 193, 7, 0.3);
        }
		</style>
		<script type="text/javascript" src="js/json2html.js"></script>
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="DatePicker/WdatePicker.js"> </script>
		<script type="text/javascript" src="js/echarts.js"></script>
	</head>
	<body>
		<div id="towrite" class="fixedBox" style="display:none;">
		<div>
        	<!-- 移除开关按钮和喇叭图片 -->
        	<!-- <button class="custom-button" onclick="togglePlaySound()"><span id="spanPlaySound" >开</span><img src="res/laba.jpg" class="button-image"></button> -->
        	<!-- <audio id="buyAudio" src="res/alert1.mp3" preload="auto"></audio>
        	<audio id="sellAudio" src="res/alert2.mp3" preload="auto"></audio> -->
		</div>
      <div class="tabs">
        <span class="tab-main active" onclick="handleClick(0)">全部</span>
        <span class="tab-buy" onclick="handleClick(1)">买单</span>
        <span class="tab-out" onclick="handleClick(2)">卖单</span>
        <!-- 已去掉文本输入框 -->
        <select onchange="handleChange()" class="filter-dropdown" id="valueFilter">
          <option value="0">全部</option>
          <option value="1000000">100万</option>
          <option value="3000000">300万</option>
          <option value="5000000">500万</option>
          <option value="10000000">1000万</option>
        </select>
        <div id="tempTitle"></div>
        <div style="display: flex; align-items: center; gap: 3px; margin-left: auto;">
          <button class="custom-button" id="aiAnalysisBtn" onclick="aiAnalysis()">AI分析</button>
          <span class="chart-btn" id="favoriteBtn" onclick="toggleFavorite()">+</span>
        </div>
      </div>
	  
			<div id="title" style="height:20px;"></div>
			<div id="chart" style="position:relative; width: 100%; height: 100%;"></div>
			<!-- <div id="towrite1" class="fixedBox" style="position:relative; float:left;margin-top:-18px;"></div> -->
		</div>
		
		<script>
      // 获取数据
	  let codeBigMoneyLastTimeMap = {}; // 股票代码最新大资金时间Map
	  let bigmoneyPlaySoundFlag = false; // 大资金语言播报开关
      var scatterData = []
      let circleType = 0
      let circlePrice = 0
      const fn = (val) => {
        let val1 = val
        if (val1.indexOf("万") != -1) {
          val1 = parseFloat(val1) * 10000;
        } else if (val1.indexOf("亿") != -1) {
          val1 = parseFloat(val1) * 100000000;
        } else {
          val1 = parseFloat(val1);
        }
        return val1
      }

	  const togglePlaySound = () => {
		bigmoneyPlaySoundFlag = !bigmoneyPlaySoundFlag;
		if (bigmoneyPlaySoundFlag) {
			playsound(true)
			let spanPlaySound = document.getElementById('spanPlaySound');
			spanPlaySound.textContent = '关';
		} else {
			let spanPlaySound = document.getElementById('spanPlaySound');
			spanPlaySound.textContent = '开';
		}
	  }

      const playsound = (isbuy) => {
		console.log('playsound')
		let audioId = 'buyAudio';
		if (!isbuy) {
			audioId = 'sellAudio';
		}
		let audioElement = document.getElementById(audioId);
  		audioElement.play();
      }

      const handleClick = (num) => {
        const arrs = ['tab-main', 'tab-buy', 'tab-out']
        arrs.forEach((v, i) => {
          const ele = document.querySelector('.' + v)
          ele.classList.remove('active')
          if (num === i) {
            ele.classList.add('active')
            circleType = i
          }
        })
        v = 1
        getSource()
      }
      const handleChange = (val) => {
        circlePrice = document.querySelector('#valueFilter').value
        v = 1
        getSource()
      }
      function getScatterData(dm) {
		dest_url = 'https://vaserviece.10jqka.com.cn/Level2/index.php?&op=mainMonitorDetail&stockcode='+dm;
		console.log('getScatterData', dest_url)
        $.ajax({
          url: 'https://vaserviece.10jqka.com.cn/Level2/index.php?&op=mainMonitorDetail&stockcode='+dm,
          type: "get",
          // dataType: "text",
          async : false,
          cache:false,
          timeout:30000,
          success: function(data) {
            const temp = JSON.parse(data)
            scatterData = []
            let listTemp = temp.list
            listTemp = listTemp.filter((v) => {
              return  (circleType !== 0 ? v.tradetype == circleType : true) && (circlePrice !== 0 ? fn(v.value) > circlePrice : true)
            })

			let isbuy = false;
			let bigmoney = false;
			let bigmoneyLastTime = '';
            listTemp.forEach((item) => {
              const curTime = item.ctime.slice(0, 5)
              item.realTime = curTime
              item.realVolumn = Math.floor(item.volume.split('手')[0])
              item.realValue = Math.floor(item.value.split('万')[0])
              item.others = [
                {
                  realVolumn: item.volume,
                  realValue: item.value,
                  nature: item.nature
                }
              ]
              const isBuy = item.tradetype === '1'
			  // 判断是否超过500万
			  if (item.realValue >= 500) {
				bigmoney = true;
			  	isbuy = isBuy;
				bigmoneyLastTime = item.realTime;
				console.log('getScatterData', isbuy, item.realTime, item.realValue, item.realVolumn);
			  }
              if (!isBuy) {
                item.realValue = -item.realValue
                item.realVolumn = -item.realVolumn
              }
              const isExistScatter = scatterData.find(v => v.realTime === curTime)
              if (isExistScatter) {
                isExistScatter.realValue = isExistScatter.realValue + item.realValue
                isExistScatter.realVolumn =  isExistScatter.realVolumn + item.realVolumn
                isExistScatter.others.push({
                  realVolumn: item.volume,
                  realValue: item.value,
                  nature: item.nature
                })
              } else {
                scatterData.push(item)
              }
            })
           
            const fn2 = (val) => {
              val = Math.abs(val)
              let num = 10000
              var sizesValue = ''
              /**
               * 判断取哪个单位
               */
              if(val < 1000){
                // 如果小于1000则直接返回
                sizesValue = ''
                return val
              }else if(val > 1000 && val < 9999){
                sizesValue = '千'
              } else if(val > 10000 && val < 99999999){
                sizesValue = '万'
              } else if(val > 100000000){
                sizesValue = '亿'
              }
              /**
               * 大于一万则运行下方计算
               */
              let i = Math.floor(Math.log(val) / Math.log(num))
              /**
               * toFixed(0)看你们后面想要取值多少，我是不取所以填了0，一般都是取2个值
               */
              var sizes = ((val / Math.pow(num, i))).toFixed(0)
              sizes = sizes + sizesValue
              return sizes
            }
            const temp3 = (fn(temp.title.mainbuy) - fn(temp.title.mainsell)).toFixed(0)
            const temp2 = temp3 < 0 ? '-' + fn2(temp3) : fn2(temp3)
            const tempColor1 = temp3 < 0 ? 'green' : 'red'
            document.getElementById('tempTitle').innerHTML = `主力买：<span style="color:red;margin-right:6px;">${temp.title.mainbuy}</span>主力卖：<span style="color:green;margin-right:6px;">${temp.title.mainsell}</span>主力净：<span style="color:${tempColor1};margin-right:6px;">${temp2}</span>`
			
			// 大资金播放提示音
			if (bigmoney) {
				//  出现大资金比较上次播放时间戳，如果时间戳有变更再播放
				if (!(dm in codeBigMoneyLastTimeMap) || (codeBigMoneyLastTimeMap[dm] < bigmoneyLastTime)) {
					console.log('getSource', dm, bigmoneyLastTime)
					// 更新最新播放时间
					codeBigMoneyLastTimeMap[dm] = bigmoneyLastTime;
					// 如果语音播报开关未打开则不进行播音
					if (bigmoneyPlaySoundFlag) {
						playsound(isbuy);
					}
				}
			}
          },
          error: function(xhr, status, errorThrown) {
            console.log(xhr, status, errorThrown);
          }
        });
      }
			var yy = 1;  //部分显示（小图）；
			window.onload = function() {
				changeStyle();
				getSource(jk);
				
			}

			$(function() {
				setInterval(function() {
					getSource(jk);
				},
				300);
			})
			
			function time_range(beginTime, endTime) {
				var strb = beginTime.split(":");
				if (strb.length != 2) {
					return false;
				}

				var stre = endTime.split(":");
				if (stre.length != 2) {
					return false;
				}

				var b = new Date();
				var e = new Date();
				var n = new Date();

				b.setHours(strb[0]);
				b.setMinutes(strb[1]);
				e.setHours(stre[0]);
				e.setMinutes(stre[1]);

				console.log('time_range', n.getTime(), b.getTime(), e.getTime());　　　　　　
				if (n.getTime() - b.getTime() > 0 && n.getTime() - e.getTime() < 0) {
					v = 1;
					console.log('time_range', true);　　　　　　
					return true;
				} else {
					console.log('time_range', false);
				    return false;
				}
			}　　　

        // 自选股票池相关函数
        const STOCK_POOL_KEY = 'stock_pool';

        function getStockPool() {
            const poolStr = localStorage.getItem(STOCK_POOL_KEY);
            if (poolStr) {
                try {
                    return JSON.parse(poolStr);
                } catch (e) {
                    console.error('Error parsing stock pool', e);
                }
            }
            return [];
        }

        function saveStockPool(pool) {
            localStorage.setItem(STOCK_POOL_KEY, JSON.stringify(pool));
        }

        function toggleFavorite() {
            // 如果股票代码或名称为空，尝试从页面获取
            if (!gpdm || !gpmc) {
                // 从页面标题获取股票名称
                const titleDiv = document.getElementById('title');
                if (titleDiv && titleDiv.innerText) {
                    // 例如 "000001   平安银行   2025-10-02"
                    const arr = titleDiv.innerText.split(/\s+/);
                    if (arr.length >= 2) {
                        gpdm = arr[0];
                        gpmc = arr[1];
                    }
                }
            }
            if (!gpdm || !gpmc) {
                alert('请先加载股票数据');
                return;
            }
            const pool = getStockPool();
            const existingIndex = pool.findIndex(item => item.code === gpdm);
            const btn = document.getElementById('favoriteBtn');
            
            if (existingIndex !== -1) {
                // 已在池中，移除
                pool.splice(existingIndex, 1);
                btn.textContent = '+';
                btn.classList.remove('in-pool');
            } else {
                // 不在池中，加入
                const date = new Date();
                const dateString = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                pool.push({ 
                    code: gpdm, 
                    name: gpmc,
                    date: dateString,
                    change: 0 // 默认涨跌幅
                });
                btn.textContent = '-';
                btn.classList.add('in-pool');
            }
            saveStockPool(pool);
        }

        function isInStockPool(stockCode) {
            return getStockPool().some(item => item.code === stockCode);
        }

   　　　
			function changeStyle() {
				var div = document.getElementById("towrite");
				div.style.display= "block";
				//div.style.border= "1px solid #fff";
				div.style.border= "none";
				div.style.marginTop= "0";
				div.style.left= "0px";
				div.style.width= "100%";
				div.style.height= "100vh";
				div.style.fontSize= "14px";
				div.style.padding= "0";
				div.style.overflow= "hidden";
				
				var div1 = document.getElementById("chart");
				div1.style.border= "1px solid #696969";
				div1.style.marginTop= "0";
				div1.style.left= "0px";
				div1.style.width= "100%";
				div1.style.height= "calc(100vh - 120px)";
				

			}
			
			Date.prototype.Format = function (fmt) {
				var o = {
				"M+": this.getMonth() + 1, //月份
				"d+": this.getDate(), //日
				"h+": this.getHours(), //小时
				"m+": this.getMinutes(), //分
				"s+": this.getSeconds(), //秒
				"q+": Math.floor((this.getMonth() + 3) / 3), //季度
				"S": this.getMilliseconds() //毫秒
				};
				if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				for (var k in o)
				if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
				return fmt;
			};
			
			function keepTwoDecimal(num) {
               var result = parseFloat(num);
               if (isNaN(result)) {
                   return false;
               }
               result = Math.round(num * 100) / 100;
               return result;
			}
			
			function NumberTransform(num) {
				var result = num;
				if(Math.abs(num) > 100000000){
					result = num / 100000000;
					result = result.toFixed(0) + "亿";
				}else if(Math.abs(num) > 10000){
					result = num/10000;
					result = result.toFixed(0) + "万";
				}
				return result;
			};
			
			var z = 0;  //刷新
			var v = 0;	//刷新
			var gpdm = "";
			var gpmc = "";
			var rq = "";
			var preClose = 0;	//昨收盘
			var jk = 0;  //默认是否显示竞价
			function getSource(p) {
				var u = decodeURI(window.location.href);
				var dm = "";
				// 去掉文本输入框相关代码
				// var dm2 = document.getElementById('inputDm').value;
				if(u.indexOf("##") > -1){
					var gp = u.split('##');
					dm = gp[1];
					gpmc = gp[2];
					if(gp[3] != undefined){
						yy = gp[3];
					}
				}
				// 修正默认代码逻辑
				if (dm == 'xxxxxx' || dm == ''){
				  dm="000001";
				  gpmc="000001";
				}
				
				
				console.log('getSource', dm, gpdm, v, p, jk);
				if(dm != gpdm || v == 1 || p != jk){
					//alert(p)
					console.log('dm != gpdm || v == 1 || p != jk');
					v = 0;
					jk = p;
					gpdm = dm;
					var dms = "";
					var dmt = "";
					if(dm.substr(0,1)=="6"){
						dms = "SH" + dm;
						dmt = "1." + dm;
					}else{
						dms = "SZ" + dm;
						dmt = "0." + dm;
					}
					
					if(dm == "999999"){
						dmt = "1.000001";
					}else if(dm.substr(0,3)=="399"){
						dmt = "0." + dm;
					}
					
					// 构建选股宝API的股票代码格式
					var xgbCode = "";
					if(dm.substr(0,1)=="6"){
						xgbCode = dm + ".SS";
					}else{
						xgbCode = dm + ".SZ";
					}
					
					var url ="https://api-ddc-wscn.xuangubao.com.cn/market/trend?fields=tick_at,close_px,avg_px,turnover_volume,turnover_value,open_px,high_px,low_px,px_change,px_change_rate&prod_code=" + xgbCode;
					var res = [];
					$.ajax({
						type: "get",
						url: url,
						dataType: "json",
						async : false,
						cache:false,
						timeout:3000,
						success: function(data) {
							console.log('选股宝API返回数据:', data);
							if(data.code === 20000 && data.data && data.data.candle && data.data.candle[xgbCode]) {
								var stockData = data.data.candle[xgbCode];
								preClose = stockData.pre_close_px;
								var lines = stockData.lines;
								gpmc = gpdm; // 选股宝API不返回股票名称，使用代码作为名称
								
								// Update favorite button
								const btn = document.getElementById('favoriteBtn');
								if (btn) {
									const isInPool = isInStockPool(gpdm);
									btn.textContent = isInPool ? '-' : '+';
									if (isInPool) {
										btn.classList.add('in-pool');
									} else {
										btn.classList.remove('in-pool');
									}
								}
								
								// 处理分时数据
								for (var i = 0; i < lines.length; i++){
									var line = lines[i];
									// 字段顺序: tick_at, close_px, avg_px, turnover_volume, turnover_value, open_px, high_px, low_px, px_change, px_change_rate
									var timestamp = line[0]; // Unix时间戳
									var date = new Date(timestamp * 1000);
									var time = date.getHours().toString().padStart(2, '0') + ":" + date.getMinutes().toString().padStart(2, '0');
									
									if(i == 0){
										rq = date.getFullYear() + "-" + (date.getMonth()+1).toString().padStart(2, '0') + "-" + date.getDate().toString().padStart(2, '0');
									}
									
									if(jk == 0){
										if(Number(time.replace(":","")) >= 930){
											var rc = {
												"time": time,
												"open": Number(line[5]), // open_px
												"close": Number(line[1]), // close_px
												"high": Number(line[6]), // high_px
												"low": Number(line[7]), // low_px
												"vol": Number(line[3]), // turnover_volume
												"jprice": Number(line[2]) // avg_px
											}
											res.push(rc);
										}
									}else{
										var rc = {
											"time": time,
											"open": Number(line[5]), // open_px
											"close": Number(line[1]), // close_px
											"high": Number(line[6]), // high_px
											"low": Number(line[7]), // low_px
											"vol": Number(line[3]), // turnover_volume
											"jprice": Number(line[2]) // avg_px
										}
										res.push(rc);
									}
								}
							} else {
								console.error('选股宝API返回数据格式错误:', data);
								// 如果API调用失败，使用默认数据
								preClose = 0;
								gpmc = gpdm;
							}
						},
						error: function(xhr, status, errorThrown) {
							console.error('选股宝API调用失败:', xhr, status, errorThrown);
							// API调用失败时的处理
							preClose = 0;
							gpmc = gpdm;
						}
					})
          			getScatterData(dm)
					//alert(JSON.stringify(res))
					//document.write("<br>"+rq + "<br>");
					//document.write(JSON.stringify(res));
					var div = document.getElementById('title');
					
					var jj = '<a href="javascript:getSource(0);"  id="jj"  style="padding-left:20px;font-size:14px;">竞价</a>';
					if(jk == 0){
						jj = '<a href="javascript:getSource(1);"  id="jj"  style="padding-left:20px;font-size:14px;">竞价</a>';
					}
					
					if(yy == 1){
						div.innerHTML = '<font size="2">' + gpdm + "&nbsp;&nbsp;&nbsp;" + gpmc + "&nbsp;&nbsp;&nbsp;" + rq + jj + "</font>";
						var aObj = document.getElementById("jj");
						aObj.style.color = "#fff";
					}else{
						div.style.margin= "-3px 0px 0px 0px";
						div.innerHTML = '<font size="1">' + gpdm + "&nbsp;&nbsp;&nbsp;" + gpmc + "</font>";
					}
					if(jk == 1){
						aObj.style.color = "#00FFFF";
					}
					
					GetChart(res);
				} else {
					//console.log('getSource', z);
					z++;
					if(z == 60){
						z = 0;
						time_range("9:00","15:15")  //刷新数据
						//time_range("9:00","23:15")  //测试, 刷新数据
					}
				}
			}
			
			function getParamValues(name, arr) {
				var ret = []
				var len = 256;
				if(jk == 0){
					len = 241;
				}
				for (var i = 0; i < len; i++) {
					if(arr[i] != undefined){
						ret.push(arr[i][name])
					}else{
						ret.push(null)
					}
				}
				return ret
			}
			
			function ratioCalculate(price, yclose) {  //涨跌幅
			  return ((price - yclose) / yclose * 100).toFixed(2);
			}
			
		</script>
		<script>
			function GetChart(arr) {
    var chartDom = document.getElementById('chart');
    // 1. 检查宽高
    if (chartDom.offsetWidth === 0 || chartDom.offsetHeight === 0) {
        // 容器不可见或未设置宽高，直接返回
        return;
    }
    // 2. 销毁已有实例
    if (echarts.getInstanceByDom(chartDom)) {
        echarts.getInstanceByDom(chartDom).dispose();
    }
    var myChart = echarts.init(chartDom);

    // 修复 top21 未定义问题
    var top21 = 80; // 主力净标题的纵向百分比位置，默认值可根据实际页面调整
    var top2 = 65;  // 成交量 grid 的纵向百分比位置，默认值可根据实际页面调整

    var res = getParamValues("close", arr);
				
				//过滤null
				var values = arr.map(function(o){
					return o.close;
				}).filter(function(val) {
					return val !== null
				});
				
				//alert(JSON.stringify(values))
				var maxa = Math.max(...values);
				var mina = Math.min(...values);
				var zfa = Math.abs((maxa / preClose - 1));
				var zfb = Math.abs((mina / preClose - 1));
				
				function min() {
					if(zfa >= zfb){
						return Number(preClose * (1 - zfa)).toFixed(2)
					}else{
						return mina
					}
				}
				function max() {
					if(zfb >= zfa){
						return Number(preClose * (1 + zfb)).toFixed(2)
					}else{
						return maxa
					}
				}
				
				var _interval = ((preClose-min()) / 4);
				var left = "5%";
				var right = "8%";
				var fsize = "14";
				var show = true;
				if(yy == 0){
					_interval = ((preClose-min()) / 2);
					left = "8%";
					right = "12%";
					fsize = "12";
					show = false;
				}
				var jm = "09:30";
				if(jk == 0){
					jm = "";
				}
        function getScatterSourceData (arr) {
          
          const time = getParamValues("time", arr)
          const close = getParamValues("close", arr)
          time.forEach((v, i) => {
            const isExist = scatterData.find(scatter => scatter.realTime === v)
            if (isExist) {
            } else {
              close[i] = 0
            }
          })
          return close
        }
				var option = {
					animation: false, //取消动画效果
					title: [
						{
							left: 'left',
							//text: '分时图'
						},
						{
							left: 'left',
							//text: '分时图'
						},
						{
							show: show,
							top: top21 + "%",
							left: 'left',
							text: '成交量',
							textStyle: {
								color: "#fff", // 文字的颜色。
								fontSize: fsize,
							}
						}
					],
					tooltip: {   //提示框
						show: show,
						trigger: 'axis',
						position: function (point, params, dom, rect, size) {
            				// point: 鼠标位置
            				// params: 当前数据信息
            				// dom: tooltip DOM 节点
            				// rect: 图表容器大小
            				// size: tooltip 大小

            				// 计算并返回一个数组，表示 tooltip 的 x 和 y 坐标
            				return [point[0], point[1]];
        				},
						formatter(params) {  //添加文字
							var str = params[0].name + '<br>';
							if(params[0].name != "null"){
								// 创建一个对象来存储不同类型的数据
								let data = {
									price: '',
									ratio: '',
									avgPrice: ''
								};
								
								params.forEach(item => {
									var name = item.seriesName;
									var c = '<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;left:5px;background-color:' + item.color + '"></span>';
									
									if(name == "分时"){
										data.price = c + '价格:' + item.data;
										data.ratio = c + '涨幅:' + ratioCalculate(item.data, preClose) + "%";
									}else if(name == "分时均价"){
										data.avgPrice = c + '均价:' + item.data;
									}else if(name.indexOf("成交量") > -1){
										str += c + item.seriesName + " : " + item.data + "<br>";
									} else if(item.componentSubType === 'scatter') {
										const temp = scatterData.find(v => v.realTime === item.axisValue)
										if (temp && temp.others) {
											// Initialize variables 
											let mainBuy = 0;
											let mainSell = 0;
											let passiveBuy = 0;
											let passiveSell = 0;

											// Calculate totals for each type
											temp.others.forEach((trade) => {
												let realValue = Math.floor(trade.realValue.split('万')[0]);
												if (trade.nature.includes('主买')) {
													mainBuy += realValue;
												} else if (trade.nature.includes('主卖')) {
													mainSell += realValue;
												} else if (trade.nature.includes('被买')) {
													passiveBuy += realValue;
												} else if (trade.nature.includes('被卖')) {
													passiveSell += realValue;
												}
											});

											// Add price, ratio and average price in one line
											str += `<div style="display:flex;justify-content:space-between;margin:5px 0;color:#fff;">
												<span>${data.price}</span>
												<span>${data.ratio}</span>
												<span>${data.avgPrice}</span>
											</div>`;

											// Add total buy/sell in one line
											str += `<div style="display:flex;justify-content:space-between;margin:5px 0;color:#fff;">
												<span>总买: <span style="color:#ff4444;font-weight:bold">${mainBuy + passiveBuy}万</span></span>
												<span>总卖: <span style="color:#00aa00;font-weight:bold">${mainSell + passiveSell}万</span></span>
											</div>`;

											// Rest of the bar chart code remains the same
											let maxValue = Math.max(mainBuy, mainSell, passiveBuy, passiveSell);
											const barWidth = 100;
											
											str += '<div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.7);border-radius:4px;">';
											
											// Function to create bar
											const createBar = (value, color, label) => {
											    if (value <= 0) return '';
											    const width = Math.min((value / maxValue * barWidth), 100); // 限制最大宽度
											    return `
											        <div style="display:flex;align-items:center;margin:3px 0;min-width:250px;">
											            <div style="width:40px;font-size:12px;color:#fff;padding-top:2px;">${label}</div>
											            <div style="position:relative;width:${width}px;margin:0 5px;overflow:hidden;padding-top:2px;">
											                ${temp.others.map(trade => {
											                    if (trade.nature.includes(label)) {
											                        const tradeValue = Math.floor(trade.realValue.split('万')[0]);
											                        const tradeWidth = (tradeValue / value * 100);
											                        return `
											                            <div style="
											                                position:relative;
											                                display:inline-block;
											                                background:${color};
											                                height:12px;
											                                width:${tradeWidth}%;
											                                border-right:1px dashed rgba(255,255,255,0.5);
											                            "></div>
											                        `;
											                    }
											                    return '';
											                }).join('')}
											            </div>
											            <div style="font-size:12px;color:${color};font-weight:bold;white-space:nowrap;padding-top:2px;">(${value}万)</div>
											        </div>
											    `;
											};

											// Add bars for each type
											str += createBar(mainBuy, '#ff4444', '主买');
											str += createBar(passiveBuy, '#ff9999', '被买');
											str += createBar(mainSell, '#00aa00', '主卖');
											str += createBar(passiveSell, '#44ff44', '被卖');
											
											str += '</div>';
										}
									}
								});
								return str;
							}
						}
					},
					<!-- axisPointer: {   //上下区域连接 -->

					grid: [
						{
							top: '3%',
							left: left,
							right: right,
							height: '58%'
						},
						{
							top: '3%',
							left: left,
							right: right,
							height: '58%'
						},
						{
							top: top2 + "%",
							left: left,
							right: right,
							height: '20%'
						}
					],
					xAxis: [
						{
							//type: 'category',
							gridIndex: 0,
							data: getParamValues("time", arr),
							axisLine: { show: false	}, //x轴坐标线设置
							axisTick: { show: false },
							splitLine: { show: false },
							axisLabel: { show: false },
						},
						{
							show: false,
							gridIndex: 1,
							data: getParamValues("time", arr),
							axisPointer: {show: false},
						},
						{
							type: 'category',
							gridIndex: 2,                    //对应坐标轴所在grid的索引
							data: getParamValues("time", arr),
							axisTick: { show: false },
							axisLine:{  //x轴坐标线设置
								lineStyle:{
									color:"#808080",  //x轴坐标线颜色
									width: 1   // 坐标轴线宽
								}
							},
							axisLabel:{	 //x轴标签设置
								showMaxLabel:true, //显示最大 tick(最后一天)
								interval: 0,
								//padding: [0, 0, 0, 30],
								formatter: function (value, index) {
									var c = index % 15;
									if(yy == 0){
										c = index % 60;
									}
									if(value != "null" && c == 0){
										return value
									}
								},
								textStyle:{  //x轴文字
									color:"#FFF"
								}
							}
						}
					],
					yAxis: [
    {
        type: 'value',
        gridIndex: 0,
        //position:'right',//坐标轴位置，移至右边
        //offset: 10,     //Y 轴相对于默认位置的偏移
        scale: true,   //刻度 自适应
        splitArea: {
            show: false // ← 修正这里，去掉点号
        },
        min: min(),
        max: max(),
        interval: _interval,
        splitLine:{ //y轴网格线
            show:false,
            lineStyle: {
                color: '#808080',
                width: 1,
                type: 'dashed', //（'solid'，实线类型；'dashed'，虚线类型；'dotted',点状类型）
            }
        },
        axisLine: { //y轴坐标线设置
            show: true,
            lineStyle: {
                color: '#D3D3D3', //y轴颜色
                //width: 2,    // 坐标轴线宽
                type: 'dotted',     // 坐标轴线线的类型（'solid'，实线类型；'dashed'，虚线类型；'dotted',点状类型）
            },
        },
        axisLabel: {  //y轴标签设置
            show: true,  //是否显示
             color: function (val) {
				val = Number(val).toFixed(2);
				if (val == preClose) {
				  return '#fff'
				}
				return val > preClose ? '#FF8C00' : '#7FFFAA';
			  },
			formatter: function (value){
				return keepTwoDecimal(value)
			}
        }
    },
    {
        type: 'value',
        gridIndex: 1,
        position:'right',
        offset: 10,
        scale: true,
        splitArea: {
            show: false // ← 修正这里，去掉点号
        },
        min: min(),
        max: max(),
        interval: _interval,
        splitLine:{ //y轴网格线
            show:true,
            lineStyle: {
                color: '#808080',
                width: 1,
                type: 'dashed', //（'solid'，实线类型；'dashed'，虚线类型；'dotted',点状类型）
            }
        },
        axisLine: { //y轴坐标线设置
            show: true,
            lineStyle: {
                color: '#D3D3D3', //y轴颜色
                //width: 2,    // 坐标轴线宽
                type: 'dotted',     // 坐标轴线线的类型（'solid'，实线类型；'dashed'，虚线类型；'dotted',点状类型）
            },
        },
        axisLabel: {  //y轴标签设置
            show: true,  //是否显示
            color: function (val) {
			val = Number(val).toFixed(2);
				if (val == preClose) {
					return '#fff'
				}
				return val > preClose ? '#FF8C00' : '#7FFFAA';
			},
			formatter: function (value) {
				var resul = ratioCalculate(value, preClose);
				return Number(resul).toFixed(2) + '%'
			}
        }
    },
    {
        gridIndex: 2,  //对应坐标轴所在grid的索引
        position:'right',//坐标轴位置，移至右边
        offset: 10,
        scale: true,
        splitNumber: 2,
        splitLine: {
            show:true,
            lineStyle: {
                color: '#808080',
                width: 1,
                type: 'dotted',
            }
        },
        axisLine: { //y轴坐标线设置
            show: true,
            lineStyle: {
                color: '#D3D3D3', //y轴颜色
                //width: 2,    // 坐标轴线宽
                type: 'dotted',     // 坐标轴线线的类型（'solid'，实线类型；'dashed'，虚线类型；'dotted',点状类型）
            },
        },
        axisLabel: {  //y轴标签设置
            show: true,
            formatter: function (value){
				if(value != 0){
					return NumberTransform(value)
				}else{
					return 0
				}
			}
        }
    }
					],

					series: [
						{
							name: '分时',
							type: 'line',
							gridIndex: 0,
							xAxisIndex: 0,
							yAxisIndex: 0,
							data: getParamValues("close", arr),
							itemStyle: {
								normal: {
									lineStyle: {
										width: 2,//折线宽度
										color: "#D3D3D3"//折线颜色
									},
									color: '#D3D3D3',//拐点颜色
								}
							},

							markLine:{   //增加标注线
								name:'昨日收盘价',
								symbol: ['none', 'none'],
								label:{
									show:false,
									formatter:  preClose,
									position: 'start',
								},
								lineStyle: {
									color: '#4289c5',
									type: 'solid'
								},
								data: [{
									yAxis: preClose
								}]
							}
						},
						{
							name: '分时均价',
							type: 'line',
							gridIndex: 0,
							xAxisIndex: 0,
							yAxisIndex: 0,
							data: getParamValues("jprice", arr),
							itemStyle: {
								normal: {
									lineStyle: {
										width: 2,//折线宽度
										color: "#EBEB00"//折线颜色
									},
									color: '#EBEB00',//拐点颜色
								}
							}
						},
						{
							name: '分时涨幅',
							type: 'line',
							gridIndex: 1,
							xAxisIndex: 1,
							yAxisIndex: 1,
							data: getParamValues("close", arr),
							smooth: true,
							symbol: "none",
							lineStyle: { //标线的样式
								normal: {
									width: 0
								}
							},
							markLine:{ //增加标注线
								name:'竞价',
								symbol: ['none', 'none'],
								label:{
									show:false,
									position: 'start',
								},
								lineStyle: {
									color: '#fff',
									type: 'solid'
								},
								data: [{
									xAxis: jm
								}]
							}
						},
						{
							name: '成交量',
							type: 'bar',
							gridIndex: 2,
							xAxisIndex: 2,
							yAxisIndex: 2,
							data: getParamValues("vol", arr),
							barWidth: 2,  //柱状图宽度
							itemStyle: {
								color: '#DAA520',
							},
							markLine: {   //增加标注线
								name:'竞价',
								symbol: ['none', 'none'],
								label:{
									show:false,
									position: 'start',
								},
								lineStyle: {
									color: '#fff',
									type: 'solid'
								},
								data: [{
									xAxis: jm
								}]
							}
						},
            {
              type:'scatter',
              data: getScatterSourceData(arr),
              symbolSize:function (arg, opt){
                if (arg === 0) return  0
                const realValue = scatterData.find(v => v.realTime === opt.name).realVolumn
                val = Math.abs(realValue)
                const info = Math.floor(val / 1000)
                const temp = 12
    let circle = (temp + ((info - 1) * 0.1 + ((val - info * 1000) / 1000 * 0.1)) * temp).toFixed(2);
    console.log(circle)
    if (circle>60) circle=60;
                return circle
    
              },
              itemStyle:{
                color:function (arg){
                  const temp = scatterData.find(v => v.realTime === arg.name)
                  let color = 'red'
                  if (temp && temp.realVolumn < 0) {
                    color = 'green'
                  }
                  return color
                }
              },
              label: {
                show: false
              }
            }
					]
				}
				myChart.setOption(option);
				$(window).resize(myChart.resize);   //解决Echarts 隐藏再显示后宽度高度变小的问题
			}
		</script>
<!-- 在body标签内合适位置添加AI分析弹窗 -->
<div id="aiAnalysisModal" class="ai-modal" style="display:none;">
  <div id="aiAnalysisHeader" class="ai-modal-header">
    <span>AI分析</span>
    <button class="ai-modal-close" onclick="closeAiAnalysis()">×</button>
  </div>
  <div class="ai-modal-content">
    <p>这里是AI分析内容，可自定义展示。</p>
  </div>
</div>

<script>
function formatAiText(text) {
    // 转义HTML
    text = escapeHtml(text);

    // 转换 Markdown 标题（#### **标题** 或 #### 标题）
//     text = text.replace(/####\s*\*\*(.*?)\*\*/g, '<div style="margin:18px 0 8px 0;font-weight:bold;font-size:17px;color:#ffb400;">$1</div>');
//     text = text.replace(/####\s*(.*?)\n/g, '<div style="margin:18px 0 8px 0;font-weight:bold;font-size:17px;color:#ffb400;">$1</div>');

    // 转换 Markdown 加粗（**文本**）
    text = text.replace(/\*\*(.*?)\*\*/g, '<b style="color:#ffb400;">$1</b>');

    // 转换 换行符 为 <br>
    text = text.replace(/\\n/g, '<br>');
    text = text.replace(/\n/g, '<br>');

    // 转换 <a href=...> 链接
    text = text.replace(/&lt;a href=(.*?)&gt;(.*?)&lt;\/a&gt;/g, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color:#4ec9ff;text-decoration:underline;">$2</a>');

    // 加粗关键词
    text = text.replace(/(建议|结论|买入|卖出|风险|提示|操作)/g, '<b style="color:#ffb400;">$1</b>');

    return text;
}

async function aiAnalysis() {
    document.getElementById('aiAnalysisModal').style.display = 'block';
    const modalContent = document.querySelector('.ai-modal-content');
    modalContent.innerHTML = '<span style="color:#aaa;">AI分析中，请稍候...</span>';

    let message = gpdm || "000001";

    try {
        const resp = await fetch('https://api.9yee.com/stock_advice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_query: message })
        });
        const data = await resp.json();
        let result = data.result || data.advice || JSON.stringify(data);

        // 格式化为气泡样式
        let bubbleHtml = `<div class="ai-bubble">${formatAiText(result)}</div>`;
        typeWriter(modalContent, bubbleHtml, 0, true);
    } catch (e) {
        modalContent.innerHTML = '<span style="color:#f66;">AI分析失败，请稍后重试。</span>';
    }
}

// 打字机效果函数（支持HTML内容）
function typeWriter(element, html, i, isHtml) {
    // 参考 chat.html，采用每次输出多个字符，速度更快
    const speed = 10; // 每10ms刷新一次
    const step = 120;   // 每次输出6个字符
    if (!isHtml) {
        if (i < html.length) {
            element.innerHTML = html.slice(0, i + step) + '<span style="opacity:0.5;">|</span>';
            element.scrollTop = element.scrollHeight;
            setTimeout(function () {
                typeWriter(element, html, i + step, false);
            }, speed);
        } else {
            element.innerHTML = html;
            element.scrollTop = element.scrollHeight;
        }
    } else {
        let match = html.match(/<div class="ai-bubble">(.*)<\/div>/s);
        let content = match ? match[1] : html;
        let prefix = `<div class="ai-bubble">`;
        let suffix = `</div>`;
        if (i < content.length) {
            element.innerHTML = prefix + content.slice(0, i + step) + '<span style="opacity:0.5;">|</span>' + suffix;
            element.scrollTop = element.scrollHeight;
            setTimeout(function () {
                typeWriter(element, html, i + step, true);
            }, speed);
        } else {
            element.innerHTML = prefix + content + suffix;
            element.scrollTop = element.scrollHeight;
        }
    }
}

// HTML转义
function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function (m) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[m];
    });
}

// 关闭AI分析弹窗
function closeAiAnalysis() {
    document.getElementById('aiAnalysisModal').style.display = 'none';
}

// 拖拽弹窗功能
(function() {
    var modal = document.getElementById('aiAnalysisModal');
    var header = document.getElementById('aiAnalysisHeader');
    var offsetX = 0, offsetY = 0, isDown = false;

    header.onmousedown = function(e) {
        isDown = true;
        offsetX = e.clientX - modal.offsetLeft;
        offsetY = e.clientY - modal.offsetTop;
        document.onmousemove = function(e) {
            if (isDown) {
                modal.style.left = (e.clientX - offsetX) + 'px';
                modal.style.top = (e.clientY - offsetY) + 'px';
            }
        };
        document.onmouseup = function() {
            isDown = false;
            document.onmousemove = null;
            document.onmouseup = null;
        };
    };
})();
</script>

	</body>
</html>

</copilot-edited-file>
